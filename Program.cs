using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Tema_RazboiElectronic_CarpAlbertoDaniel
{
    class Program
    {
        static void Main(string[] args)
        {
            try
            {
               /* args = new string[] {"--url",
                    "http://192.168.174.137/mutillidae/index.php?page=arbitrary-file-inclusion.php",
                    "--PHPSESSID",
                    "b9e58602c361cbf0565a6a6b0858bf05"
                };*/

                if (args.Length < 1)
                {
                    Console.WriteLine("Numar de argumente insuficient.");
                    Help();
                    return;
                }
             
                var arguments = ParseArgs(args);

                Console.WriteLine("URL-ul de analizat este  : " + arguments[0]);
                Console.WriteLine("PHPSESSID = " + arguments[1] == null ? " missing " : "PHPSESSID = " + arguments[1]);
                
                ApplicationContext applicationContext = new ApplicationContext();

                applicationContext.Run(arguments[0],arguments[1]);

                Console.WriteLine("\nScanner Finished testing ..." + arguments[0]);
            }
            catch(Exception exc)
            {
                Console.WriteLine("Error : " + exc.Message);
            }
        }

        static void Help()
        {
            String ProgramName = System.AppDomain.CurrentDomain.FriendlyName;
            Console.WriteLine();
            Console.WriteLine("Usage : ");
            Console.WriteLine(ProgramName + " --url TargetURL [Optional] --PHPSESSID AuthenticatedSessionId");
        }

        static String[] ParseArgs(String[] Splitted)
        {
            var Url = String.Empty;
            String PhSessionId = null;
            bool FoundMandatory = false;
     
            for(var i = 0; i < Splitted.Length; i++)
            {
                if(Splitted[i] == "--url"){
                    if(Splitted.Length < i + 1)
                    {
                        throw new Exception("Argument Value --url not specified ");
                    }
                    Url = Splitted[i+1];
                    FoundMandatory = true;
                }
                if (Splitted[i] == "--PHPSESSID")
                {
                    if (Splitted.Length < i + 1)
                    {
                        throw new Exception("Argument Value --PHPSESSID not specified ");
                    }
                    PhSessionId = Splitted[i + 1];
                }

            }
            if (FoundMandatory == false)
                throw new Exception("Not all mandatory fileds have been found");

            return new string[] { Url, PhSessionId };
        }

    }
}
